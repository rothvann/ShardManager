syntax = "proto3";

package psychopomp;

/*
Type Declarations
*/

message ShardRange {
    int64 range_start = 1;
    int64 range_end = 2;
}

enum ShardRangeStatus {
    SHARD_RANGE_STATUS_UNKNOWN = 0;
    SHARD_RANGE_STATUS_ADDED = 1;
    SHARD_RANGE_STATUS_PENDING_ADDED = 2;
    SHARD_RANGE_STATUS_PENDING_DROPPED = 3;
    SHARD_RANGE_STATUS_FORWARDING = 4; 
    SHARD_RANGE_STATUS_PENDING_FORWARDING = 5; 
}

message ShardRangeInfo {
    ShardRange range = 1;
    ShardRangeStatus status = 2;
}

enum ShardUpdateAction {
    SHARD_UPDATE_ACTION_UNKNOWN = 0;
    SHARD_UPDATE_ACTION_ADD = 1;
    SHARD_UPDATE_ACTION_DROP = 2;
    SHARD_UPDATE_ACTION_FORWARD = 3;
}

message ShardUpdateRequest {
    int64 id = 1;
    ShardUpdateAction action = 2;
    ShardRange range = 3;
    string next_bin = 4;
}

message ShardUpdateResponse {
    int64 shard_update_id = 1;
    bool success = 2;
}

message AcknowledgeResponse {
    int64 id = 1;
}

message BinState {
    repeated ShardRangeInfo shard_range_info = 1;
}
 
/* Empty */
message RequestDrain {
}

/* Empty */
message HeartBeatResponse {
}

/* Empty */
message HeartBeatRequest {
}

message ConnectionRequest {
    string service_name = 1;
    string service_key = 2;
    string bin_name = 3;
    BinState bin_state = 4;
}

/* Empty */
message ConnectionResponse {
}

message ServerMessage {
    oneof message {
        HeartBeatRequest heartbeat_request = 1;
        ShardUpdateRequest shard_update_request = 2;
        ConnectionResponse connection_response = 3;
        AcknowledgeResponse acknowledge_response = 4;
    }
}

message ClientMessage {
    oneof message {
        HeartBeatResponse heartbeat = 1;
        ShardUpdateResponse shard_update_response = 2;
        ConnectionRequest connection_request = 3;
    }
}

/* 
Service Declarations
*/
service Psychopomp {
    rpc registerStream(stream ClientMessage) returns (stream ServerMessage);
}