syntax = "proto3";

package psychopomp;

/*
Type Declarations
*/

message ShardRange {
    int64 range_start = 1;
    int64 range_end = 2;
}

enum ShardPlacementStatus {
    PLACEMENT_STATUS_UNKNOWN = 0;
    PLACEMENT_STATUS_PREPARING = 1;
    PLACEMENT_STATUS_IDLE = 2;
    PLACEMENT_STATUS_STARTING = 3;
    PLACEMENT_STATUS_ACTIVE = 4;
    PLACEMENT_STATUS_STOPPING = 5;
    PLACEMENT_STATUS_DROPPED = 6;
}

enum HealthStatus {
    HEALTH_STATUS_UNHEALTHY = 0;
    HEALTH_STATUS_HEALTHY = 1;
}

message ShardState {
    ShardRange range = 1;
    ShardPlacementStatus status = 2;
}

enum BinStatus {
    BIN_STATUS_UNHEALTHY = 0;
    BIN_STATUS_HEALTHY = 1;
    BIN_STATUS_REQUEST_DRAIN = 2;
}

message BinState {
    repeated ShardState shard_states = 1;
    BinStatus status = 2;
}


/* 
Service Declarations
*/
enum ShardUpdateAction {
    SHARD_UPDATE_ACTION_UNKNOWN = 0;
    SHARD_UPDATE_ACTION_PREPARE = 1;
    SHARD_UPDATE_ACTION_START = 2;
    SHARD_UPDATE_ACTION_STOP = 3;
    SHARD_UPDATE_ACTION_DROP = 4;
}

message ShardUpdateRequest {
    ShardUpdateAction action = 1;
    ShardRange range = 2;
}

message ShardUpdateResponse {
    bool success = 1;
}

message HeartBeatResponse {
    BinState binState = 1;
}

/* Empty */
message HeartBeatRequest {
}

message ServerMessage {
    oneof message {
        HeartBeatRequest heartbeat_request = 1;
        ShardUpdateRequest shard_update_request = 2;
    }
}

message ClientMessage {
    oneof message {
        HeartBeatResponse heartbeat = 1;
        ShardUpdateResponse shard_update_response = 2;
    }
}

service Psychopomp {
    rpc registerStream(stream ClientMessage) returns (stream ServerMessage);
}
